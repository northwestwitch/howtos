# Starting containers in podman with systemd

Systemd is a system and service manager in Linux that allows to init and manage user processes and space.

When you set up a container to start as a systemd service, you can define the order in which the containerized service runs, check for dependencies (like making sure another service is running, a file is available or a resource is mounted, etc).

## Choose the image(s) for the container to manage from systemd
In this case I'm using a lightweight MondoDB image(mvertes/alpine-mongo) pulled from Docker Hub
```
podman pull mvertes/alpine-mongo
```
## Assign the images a name, so it will be later used in the systemd service file
For instance to name the container alpine-mongo "mongodb", type
```
podman run -d --name mongodb -p 27017:27017 alpine-mongo
```

## Configure the containers as systemd services by creating configuration files

First create a folder in the user's home directory that will contain all systemd unit config files:
```
mkdir -p ~/.config/systemd/user
```
Then create one config file for each service/container that is needed.
Create a service file for mongodb with the following command:
```
podman generate systemd --name mongodb
```
This file will look like this:
```
# container-mongodb.service
# autogenerated by Podman 2.2.1
# Fri Jan 22 02:43:58 UTC 2021

[Unit]
Description=Podman container-mongodb.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
ExecStart=/usr/bin/podman start mongodb
ExecStop=/usr/bin/podman stop -t 10 mongodb
ExecStopPost=/usr/bin/podman stop -t 10 mongodb
PIDFile=/run/user/1000/containers/vfs-containers/e47e9c935762c4a9a255316cfde8359f25adc8d0f63941f9f72944570e07e02e/userdata/conmon.pid
KillMode=none
Type=forking

[Install]
WantedBy=multi-user.target default.target
```
Create a service config file under ~/.config/systemd/user:
```
touch ~/.config/systemd/user/container-mongodb.service
```
And copy the generated file content into this .service file.

After creating the unit file, to start the container automatically at boot time, type the following:
```
systemctl --user daemon-reload
systemctl --user enable container-mongodb.service
```

Once the service is enabled, it will start at boot time. To start it immediately and check the status of the service, type the following:
```
systemctl --user start container-mongodb.service
systemctl --user status container-mongodb.service
```
```
The output will be something like this:
[vagrant@localhost user]$ systemctl --user start container-mongodb.service
[vagrant@localhost user]$ systemctl --user status container-mongodb.service
● container-mongodb.service - Podman container-mongodb.service
   Loaded: loaded (/home/vagrant/.config/systemd/user/container-mongodb.service; enabled; vendor preset: enabled)
   Active: active (running) since Fri 2021-01-22 03:06:29 UTC; 52s ago
     Docs: man:podman-generate-systemd(1)
  Process: 34411 ExecStopPost=/usr/bin/podman stop -t 10 mongodb (code=exited, status=0/SUCCESS)
  Process: 34449 ExecStart=/usr/bin/podman start mongodb (code=exited, status=0/SUCCESS)
 Main PID: 34484 (conmon)
   CGroup: /user.slice/user-1000.slice/user@1000.service/container-mongodb.service
           ├─3446s6 /usr/bin/slirp4netns --disable-host-loopback --mtu 65520 --enable-sandbox --enable-seccomp -c -e 3 -r 4 --netns-type=path /run/user/1000/netns/cni-3100ed80-c456-8066>
           ├─34468 containers-rootlessport
           ├─34472 containers-rootlessport-child
           ├─34484 /usr/bin/conmon --api-version 1 -c e47e9c935762c4a9a255316cfde8359f25adc8d0f63941f9f72944570e07e02e -u e47e9c935762c4a9a255316cfde8359f25adc8d0f63941f9f72944570e07e0>
           └─e47e9c935762c4a9a255316cfde8359f25adc8d0f63941f9f72944570e07e02e
             └─34493 mongod --bind_ip 0.0.0.0
lines 1-14/14 (END)
```
To stop the container use the following stop command:
```
[vagrant@localhost user]$ systemctl --user stop container-mongodb.service
[vagrant@localhost user]$ systemctl --user status container-mongodb.service
● container-mongodb.service - Podman container-mongodb.service
   Loaded: loaded (/home/vagrant/.config/systemd/user/container-mongodb.service; enabled; vendor preset: enabled)
   Active: inactive (dead) since Fri 2021-01-22 03:10:07 UTC; 3s ago
     Docs: man:podman-generate-systemd(1)
  Process: 34572 ExecStopPost=/usr/bin/podman stop -t 10 mongodb (code=exited, status=0/SUCCESS)
  Process: 34545 ExecStop=/usr/bin/podman stop -t 10 mongodb (code=exited, status=0/SUCCESS)
  Process: 34449 ExecStart=/usr/bin/podman start mongodb (code=exited, status=0/SUCCESS)
 Main PID: 34484 (code=exited, status=0/SUCCESS)
   CGroup: /user.slice/user-1000.slice/user@1000.service/container-mongodb.service
[vagrant@localhost user]$
```
